%define krb 0
%define vdt 0
%define epel 0
%define ssl 0
%{?_with_krb:%define krb 1}
%{?_with_vdt:%define vdt 1}
%{?_with_epel:%define epel 1}
%{?_with_ssl:%define ssl 1}

%if %vdt || %epel
%define gsi 1
%else
%define gsi 0
%endif

Name: @PACKAGE@
Version: @VERSION@
Release: @VER_PATCH@
Summary: Client Tools for dCache

Group: Applications/Internet

License: LGPLv2+ and BSD
URL: http://www.dcache.org/manuals/libdcap.shtml 
Source0: https://github.com/dCache/%{name}/archive/%{version}.tar.gz

BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
Requires:       %{name}-libs%{?_isa} = %{version}-%{release}
BuildRequires:  globus-gssapi-gsi-devel
BuildRequires:  krb5-devel
BuildRequires:  openssl-devel
BuildRequires:  autoconf
BuildRequires:  automake
BuildRequires:  libtool

%if %{?fedora}%{!?fedora:0} || %{?rhel}%{!?rhel:0} >= 6
#               No CUnit in EPEL 5
BuildRequires:  CUnit-devel
%endif

%description
dCache is a distributed mass storage system.
This package contains the client components.

%package libs
Summary:	Client Libraries for dCache
Group:		System Environment/Libraries
License:	LGPLv2+

%description libs
dCache is a distributed mass storage system.
This package contains the client libraries.

%package devel
Summary:	Client Development Files for dCache
Group:		Development/Libraries
License:	LGPLv2+
Requires:	%{name}-libs%{?_isa} = %{version}-%{release}

%description devel
dCache is a distributed mass storage system.
This package contains the client development files.

%package tunnel-gsi
Summary:	GSI tunnel for dCache
Group:		System Environment/Libraries
License:	LGPLv2+ and BSD
Requires:	%{name}-libs%{?_isa} = %{version}-%{release}

%description tunnel-gsi
This package contains the gsi tunnel plugin library used by dcap-libs.
This library is dynamically loaded at runtime.

%package tunnel-krb
Summary:	Kerberos tunnel for dCache
Group:		System Environment/Libraries
License:	LGPLv2+ and BSD
Requires:	%{name}-libs%{?_isa} = %{version}-%{release}

%description tunnel-krb
This package contains the kerberos tunnel plugin library used by dcap-libs.
This library is dynamically loaded at runtime.

%package tunnel-ssl
Summary:	SSL tunnel for dCache
Group:		System Environment/Libraries
License:	LGPLv2+
Requires:	%{name}-libs%{?_isa} = %{version}-%{release}

%description tunnel-ssl
This package contains the ssl tunnel plugin library used by dcap-libs.
This library is dynamically loaded at runtime.

%package tunnel-telnet
Summary:	Telnet tunnel for dCache
Group:		System Environment/Libraries
License:	LGPLv2+
Requires:	%{name}-libs%{?_isa} = %{version}-%{release}

%description tunnel-telnet
This package contains the telnet tunnel plugin library used by dcap-libs.
This library is dynamically loaded at runtime.

%prep
%setup -q

sed 's!@@LIBDIR@@!%{_libdir}!' -i src/tunnelManager.c

%build
#chmod +x bootstrap.sh
#./bootstrap.sh

%configure \
    --disable-static \
    --with-globus-include=%{_includedir}/globus \
    --with-globus-lib=/dummy \
    --with-doc-dir=/usr/share/doc/@PACKAGE@-@VERSION@ \
    --with-man-dir=/usr/share/man

make %{?_smp_mflags}

%install
rm -rf %{buildroot}

make install DESTDIR=%{buildroot}

# Remove libtool archive files
rm -rf %{buildroot}/%{_libdir}/*.la

# Move plugins out of the default library path
mkdir %{buildroot}/%{_libdir}/%{name}
mv %{buildroot}/%{_libdir}/lib*Tunnel* %{buildroot}/%{_libdir}/%{name}

# We are installing the docs in the files sections
rm -rf %{buildroot}/%{_docdir}

%clean
rm -rf %{buildroot}

%if %{?fedora}%{!?fedora:0} || %{?rhel}%{!?rhel:0} >= 6
%check
make %{?_smp_mflags} check
%endif

%post libs -p /sbin/ldconfig

%postun libs -p /sbin/ldconfig

# Redefine license as doc for old rpm versions (EPEL 5 and 6)
%{!?_licensedir: %global license %%doc}

%files
%{_bindir}/dccp
%{_mandir}/%{name}-%{version}/man1/dccp.1*

%files libs
%{_libdir}/libdcap.so.*
%{_libdir}/libpdcap.so.*
%dir %{_libdir}/%{name}
%license LICENSE COPYING.LIB AUTHORS

%files devel
%{_libdir}/libdcap.so
%{_libdir}/libpdcap.so
%{_includedir}/dc_hack.h
%{_includedir}/dcap.h
%{_includedir}/dcap_errno.h

%files tunnel-gsi
%{_libdir}/%{name}/libgsiTunnel.so
%license plugins/gssapi/Copyright

%files tunnel-krb
%{_libdir}/%{name}/libgssTunnel.so
%license plugins/gssapi/Copyright

%files tunnel-ssl
%{_libdir}/%{name}/libsslTunnel.so

%files tunnel-telnet
%{_libdir}/%{name}/libtelnetTunnel.so

%changelog
* Fri Dec 18 2015 Christian Bernardt <christian.bernardt@desy.de> - 2.47.10-1
- New release
- Update spec file used for make rpm using fedora as template
